---
title: 'Monitoring the spread of COVID-19 by estimating reproduction numbers over time'
output:
  html_document:
    theme: lumen
    self_contained: false
    lib_dir: html_libraries
---

Created by
[Prof. Dr. Thomas Hotz](https://www.tu-ilmenau.de/stochastik/team/thomas-hotz/),
[Stefan Heyder](https://www.tu-ilmenau.de/stochastik/team/stefan-heyder/),
[Matthias Glock](https://www.tu-ilmenau.de/stochastik/team/matthias-glock/)
and [Sebastian Semper](https://www.tu-ilmenau.de/stochastik/team/sebastian-semper/)
of the
[AG Stochastik](https://www.tu-ilmenau.de/stochastik/), [Technische Universität Ilmenau](https://www.tu-ilmenau.de/)
<br/>
in collaboration with
[Prof. Dr. Alexander Krämer](https://ekvv.uni-bielefeld.de/pers_publ/publ/PersonDetail.jsp?personId=21463&lang=de)
and
[Anne Böhle](mailto:anne.boehle@uni-bielefeld.de)
of the
[School of Public Health](https://www.uni-bielefeld.de/gesundhw/index.html), [Bielefeld University](https://www.uni-bielefeld.de/).


```{r libraries, echo = F, message = F, warning = F, results='hide'}
library(lubridate, warn.conflicts = F)
library(plotly, warn.conflicts = F)
library(stringr, warn.conflicts = F)
Sys.setlocale('LC_TIME', 'C')
source("plot.r")
source("estimator.r")

```

```{r data, echo = F}
johns_hopkins <- read.csv("data/clean/data_world_jh.csv")
world_tot <- read.csv("data/clean/data_world_tot.csv")
```

## {.tabset .tabset-fade .tabset-pills}

<!--
See https://github.com/rstudio/flexdashboard/issues/80#issuecomment-247139450
on generating tabs in rmarkdown automatically
-->
```{r, echo = F, warning = F, message = F}
numcountries <- 20

# add world tot. cases to johns-hopkins data
world_tot$reg0.name <- "World"
johns_hopkins <- merge(johns_hopkins, world_tot, all=TRUE)

maxdate <- max(johns_hopkins$date)
df <- subset(johns_hopkins, date == maxdate, select = c(reg0.name, tot.cases))
df <- df[rev(order(df$tot.cases)),]
countries <- unique(df$reg0.name[1:(numcountries + 1)])

plots <- lapply(countries, function(country_name) {
    fname <- paste0("data/estimates/", country_name, "_JHU_R.csv")
    estimates <- read.csv(fname)
    estimates$date <- as.Date(estimates$date)

    plot_repronum(estimates, country_name, language = "en")
})

out <- lapply(seq_along(plots), function(i) {
    tab_header <- knitr::knit_expand(text = sprintf("### %s\n", countries[i]))
    chunk_start <- knitr::knit_expand(text = "\n```{r, echo = F, fig.width = 10, warning = FALSE}")

    plot_content <- knitr::knit_expand(text = sprintf("\nplots[[%d]]", i))

    chunk_end <- knitr::knit_expand(text = "\n```\n")

    fname <- paste0(countries[i], "_JHU_R.csv")

    download_text <- "<details> 
    <summary> data download (last update: ${format(Sys.time(), '%d.%m.%Y, %H:%M', tz = 'Europe/Berlin')}) </summary>

    You can download the data for this plot <a href='data/estimates/${fname}'>here</a>.

    This file contains the following columns:
    <ul>
        <li><b>date</b> the date,</li>
        <li><b>new.cases</b> the amount of new cases on that day,</li>
        <li><b>repronum</b> the estimated reproduction number on that day,</li>
        <li><b>repronum.se</b> the (estimated) standard error of the reproduction number estimate,</li>
        <li><b>ci.lower</b> the lower bound of the 95% confidence interval and</li>
        <li><b>ci.upper</b> the upper bound of the 95% confidence interval.</li>
    </ul>
    </details>
    \n"

    download_text <- str_interp(download_text)
    paste(tab_header, chunk_start, plot_content, chunk_end, download_text, collapse = '\n')
})

```

`r paste(knitr::knit(text = paste(out, collapse = '\n')))`

##

We show results for the world and for the `r numcountries` most affected countries  (by total number of infections). Results for all available countries can be found [here](all.html). Further results for Germany and its federal states (Bundesländer) based on official data are available [here](germany.html) (in German).

```{r echo=FALSE, results="asis"}
cat(paste(
    gsub("!NOW!", format(Sys.time(), '%d/%m/%y %H:%M', tz = "GMT"),
        readLines("notes.md")),
"\n"), sep = "\n")
```
